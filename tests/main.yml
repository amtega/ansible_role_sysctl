---
# Tasks for testing role

- name: Run idempotence test
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `debian-9`)
           || starts_with(name, `fedora-27`)
           || starts_with(name, `fedora-28`) ]

    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: Prepare docker containers for test
  hosts: docker_sandbox_containers
  tasks:
    - name: Setup extra sysctl configs
      set_fact:
        sysctl_extra:
          - name: Hardlinks
            path: /etc/sysctl.d/50-hardlinks.conf
            options:
              - name: Fs.protected_hardlinks
                value: 1
  tags:
    - idempotence

- name: Test sysctl role
  hosts: docker_sandbox_containers
  roles:
    - amtega.sysctl
  vars:
    sysctl_load_from_hostvars: yes
    sysctl_options_defaults:
      state: present
      reload: no
    sysctl:
      - name: Main
        options:
          - name: Kernel.printk
            value: 3 4 1 7
          - name: Net.ipv6.conf.all.disable_ipv6
            value: 1
  tasks:
    - name: Read /etc/sysctl file
      command: cat /etc/sysctl.conf
      changed_when: false
      register: read_main_sysctl_result

    - name: Read /etc/sysctl.d/50-hardlinks.conf file
      command: cat /etc/sysctl.d/50-hardlinks.conf
      changed_when: false
      register: read_hardlinks_sysctl_result

    - name: Check that sysctl configs are present
      assert:
        that:
          - >-
            read_main_sysctl_result.stdout
            is search("kernel.printk=3 4 1 7")
          - >-
            read_hardlinks_sysctl_result.stdout
            is search("fs.protected_hardlinks=1")
  tags:
    - idempotence

- name: Cleanup docker docker sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
